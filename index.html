<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Emargement JPO</title>
</head>

<body class="cont">
    <h3 class="txt-cntr mar-top-2">JPO du 09/12/23</h3>

    <article class="pad-2">
        <section>
            <div class="frm-grp txt-cntr">
                <label class="disp-blck">Choisissez la caméra :</label>
                <select id="webcameraChanger" onchange="cameraChange($(this).val());" class="frm-ctrl mar-btm-2"></select>
            </div>
            <!-- Composant de vue de la caméra Web -->
            <video id="webcameraPreview" playsinline autoplay controls muted loop style="width: 100%;"></video>
        </section>
    </article>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="../../external/adapter.min.js"></script>
    <script type="text/javascript" src="../../external/instascan.js"></script>
    <script type="text/javascript" src="../../src/QrCodeScanner.js"></script>
    <script type="text/javascript" src="https://apis.google.com/js/api.js"></script>

    <script type="text/javascript">
        var videoComponent = $("#webcameraPreview");
        var webcameraChanger = $("#webcameraChanger");
        var options = {};
        var cameraId = 0;

        // Initialise les options pour le scanner
        options = initVideoObjectOptions("webcameraPreview");

        // Initialise le scanner
        initScanner(options);

        // Initialise les caméras disponibles
        initAvaliableCameras(
            webcameraChanger,
            function () {
                cameraId = parseInt(getSelectedCamera(webcameraChanger));
            }
        );

        // Initialise la caméra sélectionnée
        initCamera(cameraId);
        scanStart(function (data) {
            alert(data+ " a été enregistré avec succès")
        });

        // Initialise l'API Google Sheets
        gapi.load('client', initSheetsAPI);

        function initSheetsAPI() {
            gapi.client.init({
                apiKey: 'AIzaSyDuSVZIxItzg1u85BS2LPyFo9ovSXQ54pw',
                clientId: '549585339883-3p01j2inukmo7nrg9tnpdglisg1splrf.apps.googleusercontent.com',
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                scope: "https://www.googleapis.com/auth/spreadsheets"
            }).then(function () {
                // ID de votre feuille de calcul
                var spreadsheetId = '1gvvhXBmO_0rPJvCNYiO9yXBgd2PRjNTw1PKlwE-3dqQ';
                // Fonction pour ajouter des données à la feuille de calcul
                function appendDataToSheet(email) {
                    console.log('Tentative d\'ajout de données à la feuille de calcul...');
                    
                    var values = [
                        [email]
                    ];
                    
                    var body = {
                        values: values
                    };
                    
                    gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: spreadsheetId,
                        range: 'scan',
                        valueInputOption: 'RAW',
                        resource: body
                    }).then(function (response) {
                        console.log('Données ajoutées avec succès :', response);
                    }, function (reason) {
                        console.error('Erreur lors de l\'ajout des données :', reason.result.error.message);
                    });
                }
                // Démarre la numérisation
                scanStart(function (data) {
                    // Supposons que les données scannées soient une adresse e-mail
                    appendDataToSheet(data);
                    alert(data+ " a été enregistré avec succès")
                });
            });
        }
    </script>
</body>
</html>
