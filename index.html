<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Scanner</title>
    <script src="https://cdn.rawgit.com/serratus/quaggaJS/master/dist/quagga.min.js"></script>
</head>
<body>
    <h1>Emargement JPO 09/12/23</h1>
    <video id="preview" style="width:100%"></video>

    <script>
        // Replace with your Google Sheets API key and client ID
        // Replace with your Google Sheets API key and client ID
        const apiKey = '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';
        const clientId = '549585339883-3p01j2inukmo7nrg9tnpdglisg1splrf.apps.googleusercontent.com';
        const spreadsheetId = '1gvvhXBmO_0rPJvCNYiO9yXBgd2PRjNTw1PKlwE-3dqQ';


        // Initialize Google Sheets API
        gapi.load('client', initGoogleSheets);

        function initGoogleSheets() {
            gapi.client.init({
                'apiKey': apiKey,
                'clientId': clientId,
                'scope': 'https://www.googleapis.com/auth/spreadsheets',
            }).then(function () {
                console.log('Google Sheets API initialized');
            });
        }

        // Initialize QuaggaJS
        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#preview'),
                constraints: {
                    width: 640,
                    height: 480,
                },
            },
            decoder: {
                readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader", "2of5_reader", "code_93_reader"],
            },
        }, function (err) {
            if (err) {
                console.error(err);
                return;
            }
            Quagga.start();
        });

        Quagga.onDetected(function (result) {
            const email = result.code; // Assuming the QR code contains the email address

            // Update Google Sheets checkbox in column I
            updateCheckbox(email);
        });

        function updateCheckbox(email) {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: spreadsheetId,
                range: 'Sheet1!G:I', // Adjust the sheet name and range as needed
            }).then(function (response) {
                const data = response.result.values;
                const rowIndex = data.findIndex(row => row[0] === email);

                if (rowIndex !== -1) {
                    // Checkbox is in column I (index 2)
                    gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: spreadsheetId,
                        range: `Sheet1!I${rowIndex + 1}`,
                        valueInputOption: 'RAW',
                        values: [[true]],
                    }).then(function (response) {
                        console.log('Checkbox updated successfully');
                    }, function (reason) {
                        console.error('Error: ' + reason.result.error.message);
                    });
                }
            });
        }
    </script>
    <script src="https://apis.google.com/js/api.js"></script>
</body>
</html>
